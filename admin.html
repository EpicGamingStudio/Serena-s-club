<!doctype html>
<html>
<head><meta charset="utf-8"/><title>Admin</title></head>
<body>
  <h2>Admin panel</h2>
  <div>
    <label>Secret number:</label>
    <input id="secret" type="number" />
    <input id="min" type="number" value="1" />
    <input id="max" type="number" value="50" />
    <button id="createGame">Create / Update Game</button>
  </div>

  <h3>Guesses</h3>
  <div id="guesses"></div>
  <button id="computeWinner">Compute winner</button>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { doc, setDoc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    const GAME_DOC = 'current';
    document.getElementById('createGame').addEventListener('click', async () => {
      const secret = Number(document.getElementById('secret').value);
      const min = Number(document.getElementById('min').value);
      const max = Number(document.getElementById('max').value);
      if (isNaN(secret)) { alert('enter secret'); return; }
      await setDoc(doc(db,'games', GAME_DOC), { secretNumber: secret, min, max, active: true, createdAt: new Date() });
      alert('Game created');
    });

    document.getElementById('computeWinner').addEventListener('click', async () => {
      const gSnap = await getDoc(doc(db,'games', GAME_DOC));
      if (!gSnap.exists()) { alert('No game'); return; }
      const secret = gSnap.data().secretNumber;
      const guessCol = collection(db, 'games', GAME_DOC, 'guesses');
      const guessSnap = await getDocs(guessCol);
      let winner = null;
      let bestDiff = Infinity;
      const listEl = document.getElementById('guesses');
      listEl.innerHTML = '';
      guessSnap.forEach(docu => {
        const d = docu.data();
        const diff = Math.abs(d.guess - secret);
        const node = document.createElement('div');
        node.textContent = `${d.username || d.uid} â†’ ${d.guess} (diff ${diff})`;
        listEl.appendChild(node);
        if (diff < bestDiff) { bestDiff = diff; winner = { uid: d.uid, guess: d.guess, username: d.username }; }
      });
      if (winner) {
        await setDoc(doc(db,'games', GAME_DOC), { winnerUid: winner.uid, winnerGuess: winner.guess, active: false }, { merge: true });
        alert(`Winner: ${winner.username || winner.uid} with ${winner.guess}`);
      } else alert('No guesses yet');
    });

    // auth check - ensure logged in admin (we expect you to create an admins/{uid} doc)
    onAuthStateChanged(auth, (u) => {
      if (!u) window.location = 'index.html';
    });
  </script>
</body>
</html>