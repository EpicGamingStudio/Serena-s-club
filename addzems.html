<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Send Zems</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select { display: block; margin: 10px 0; width: 300px; }
    #status { color: green; font-weight: bold; margin-top: 10px; }
    #error { color: red; font-weight: bold; margin-top: 10px; }
    #currentZems { font-weight: bold; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Send Zems to User</h1>

  <label>Select User</label>
  <select id="userSelect">
    <option>Loading users...</option>
  </select>
  <p id="currentZems"></p>

  <label>Amount of Zems</label>
  <input type="number" id="zemsAmount" placeholder="e.g., 50" />

  <button id="sendBtn">Send Zems</button>
  <p id="status"></p>
  <p id="error"></p>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebaseConfig.js"></script>
  <script>
    const userSelect = document.getElementById("userSelect");
    const status = document.getElementById("status");
    const error = document.getElementById("error");
    const sendBtn = document.getElementById("sendBtn");
    const currentZemsDisplay = document.getElementById("currentZems");

    let usersData = {}; // store user data locally for quick Zems display

    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      // Check if current user is admin
      const admin = await isAdmin(user.uid);
      if (!admin) {
        error.innerText = "You are not an admin.";
        userSelect.disabled = true;
        sendBtn.disabled = true;
        return;
      }

      // Load all users
      const users = await loadUsers();
      usersData = {}; // reset
      userSelect.innerHTML = "";

      if (users.length === 0) {
        const option = document.createElement("option");
        option.text = "No users found";
        userSelect.appendChild(option);
        sendBtn.disabled = true;
        return;
      }

      users.forEach(u => {
        usersData[u.id] = u; // store for later
        const option = document.createElement("option");
        option.value = u.id;
        option.text = u.username || "Unknown";
        userSelect.appendChild(option);
      });

      // Show Zems of first user by default
      const firstUserId = userSelect.value;
      currentZemsDisplay.innerText = `Current Zems: ${usersData[firstUserId].zems || 0}`;
    });

    // Update Zems display when user selection changes
    userSelect.addEventListener("change", () => {
      const selectedId = userSelect.value;
      if (usersData[selectedId]) {
        currentZemsDisplay.innerText = `Current Zems: ${usersData[selectedId].zems || 0}`;
      } else {
        currentZemsDisplay.innerText = "";
      }
    });

    sendBtn.addEventListener("click", async () => {
      const userId = userSelect.value;
      const amount = parseInt(document.getElementById("zemsAmount").value);

      if (!userId || !amount) {
        alert("Select a user and enter Zems amount");
        return;
      }

      try {
        await db.collection("users").doc(userId).update({
          zems: firebase.firestore.FieldValue.increment(amount)
        });
        status.innerText = `Sent ${amount} Zems successfully!`;
        error.innerText = "";
        document.getElementById("zemsAmount").value = "";

        // Update local Zems display immediately
        if (usersData[userId]) {
          usersData[userId].zems = (usersData[userId].zems || 0) + amount;
          currentZemsDisplay.innerText = `Current Zems: ${usersData[userId].zems}`;
        }
      } catch (err) {
        console.error(err);
        error.innerText = "Error sending Zems.";
        status.innerText = "";
      }
    });
  </script>
</body>
</html>